name: Build/release

on:
  workflow_dispatch:
    inputs:
      companion-host:
        type: string
        description: Companion IP/Hostname
        default: '192.168.0.5'
        required: true
      companion-port:
        type: string
        description: Companion Port
        default: '16622'
        required: true
      armbian-url:
        type: string
        description: Armbian FW URL (Ubuntu minimal)
        default: 'http://xogium.performanceservers.nl/archive/orangepizero2/archive/Armbian_22.11.3_Orangepizero2_jammy_edge_6.1.4_minimal.img.xz'

jobs:
  pi-img:
    runs-on: ubuntu-latest
    name: build image
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: install packer
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y packer

      - name: build image
        run: |
          git clone https://github.com/bitfocus/companion-satellite.git
          cd companion-satellite/pi-image
          sudo packer init ../../companion-satellite.pkr.hcl
          sudo packer build ../../companion-satellite.pkr.hcl

      - name: compress image
        shell: bash
        run: |
          cd companion-satellite/pi-image/output-satellitepi

          sudo apt-get install -y zerofree
          device="$(sudo losetup --partscan --show --find image)"
          sudo zerofree "${device}p2"
          sudo losetup --detach "$device"

          sudo gzip -n image

      - name: Upload Armbian image
        uses: actions/upload-artifact@v3
        with:
          name: Armbian_firmware
          path: companion-satellite/pi-image/output-satellitepi/image.gz